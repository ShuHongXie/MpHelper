"use strict";var e=require("electron"),t=require("@electron/remote/main"),a=require("fs"),s=require("miniprogram-ci"),r=require("path"),n=require("uuid"),o=require("lowdb"),i=require("isomorphic-git"),c=require("shelljs");function l(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var d=l(t),u=l(a),p=l(s),h=l(r),g=l(o),f=l(i);const{app:m}=require("electron"),y=require("lowdb/adapters/FileSync"),w=require("path");console.log("renderer"===process.type?require("@electron/remote").app.getPath("userData"):m.getPath("userData"));const b=require("lodash-id"),x=new y(w.resolve("renderer"===process.type?require("@electron/remote").app.getPath("userData"):m.getPath("userData"),"db.json")),k=g.default(x);k._.mixin(b),k.has("list").value()||k.set("list",[]).write();class P{status;data;constructor(e,t={}){this.status=e,this.data=t}get setData(){return this.data}set getData(e){this.data=e}get getStatus(){return this.status}set setStatus(e){this.status=e}}const j="success",v="fail",S="win32"===process.platform,q="darwin"===process.platform;function M(e,t=!0,a=["node_modules",".git","dist"]){const s=u.default.readdirSync(e),r=[];return s.forEach((s=>{if(!a.includes(s)){const n=u.default.statSync(h.default.join(e,s));t&&n.isDirectory()?r.push(...M(h.default.join(e,s),!0,a)):r.push(h.default.join(e,s))}})),r}function D(e,t,a=!0){const s=M(e,a);console.log(s);let r=0;for(;r<=s.length;){if(t instanceof RegExp&&t.test(s[r]))return s[r];if("string"==typeof t&&s[r]&&s[r].slice(s[r].lastIndexOf(S?"\\":q?"/":"")+1)===t)return s[r];r++}return!1}let R,$,_;function A(t,a){R=0;const{type:s,params:r={}}=a;switch($=new p.default.Project({appid:r.appid,type:"miniProgram",projectPath:r.outputPath,privateKeyPath:r.privatePath,ignores:["node_modules/**/*"]}),s){case"preview":!async function(t,a){const s=n.v4();D(e.app.getPath("documents"),"mp-image",!1)||u.default.mkdirSync(h.default.join(e.app.getPath("documents"),"mp-image"));const r=h.default.join(e.app.getPath("documents"),`/mp-image/${s}.png`);try{const e=await p.default.preview({project:$,desc:a.desc,setting:{es6:!0,es7:!0,autoPrefixWXSS:!0,minifyWXML:!0,minifyWXSS:!0,minifyJS:!0,minify:!0},robot:a.robot,qrcodeFormat:"image",qrcodeOutputDest:r,pagePath:a.pagePath,searchQuery:a.searchQuery,scene:a.scene,version:"",onProgressUpdate:e=>{if("upload"!==e._msg)t.reply("previewReply",new P(j,{message:"正在编译中",index:a.index,done:!1}));else if("upload"===e._msg&&"done"===e._status){const e=function(e){e=60*e*1e3;const t=(new Date).getTime()+e,a=new Date(t),s=a.getFullYear();return console.log(a.getMonth()),`${s}-${a.getMonth()+1<10?`0${a.getMonth()+1}`:a.getMonth()+1}-${a.getDate()} ${a.getHours()<10?`0${a.getHours()}`:a.getHours()}:${a.getMinutes()<10?`0${a.getMinutes()}`:a.getMinutes()}`}(25);t.reply("previewReply",new P(j,{message:"",index:a.index,done:!0,path:`/image/${s}.png`,fullPath:r,expireTime:e})),k.read().get("list").find({id:a.id}).assign({qrcodePath:`/image/${s}.png`,fullQrcodePath:r,expireTime:e}).write()}}});console.log(e)}catch(e){if(console.log(e.message),console.log(e.name),console.log(e.stack),e.message.includes("Error")){let s="";s=e.message.includes("{")?JSON.parse(e.message.substring(e.message.indexOf("{"),e.message.lastIndexOf("}")+1)).errMsg.replace(/(\,\sreference).*/,""):e.message.slice(e.message.indexOf("Error: ")),t.reply("previewReply",new P(v,{message:s,index:a.index}))}}}(t,r);break;case"upload":!async function(e,t){console.log("start upload...");try{const a=await p.default.upload({project:$,version:t.version,desc:t.desc,setting:{es6:!0,es7:!0,autoPrefixWXSS:!0,minifyWXML:!0,minifyWXSS:!0,minifyJS:!0,minify:!0},onProgressUpdate:a=>{"upload"!==a._msg?(!R&&e.reply("uploadReply",new P(j,{message:"正在上传中",index:t.index,done:!1})),R++):"upload"===a._msg&&"done"===a._status&&(R=0,e.reply("uploadReply",new P(j,{message:"",done:!0})))}});console.log(a)}catch(a){if(R=0,a.message.includes("Error")){const s=JSON.parse(a.message.substring(a.message.indexOf("{"),a.message.lastIndexOf("}")+1));e.reply("uploadReply",new P(v,{message:s.errMsg.replace(/(\,\sreference).*/,""),index:t.index}))}}}(t,r)}}async function B(e,{type:t="",params:a={}}){switch(t){case"checkout":try{return await f.default.checkout({fs:u.default,dir:a.path,ref:a.currentBranch}),new P(j,{message:"切换成功"})}catch(e){return new P(v,{message:e})}break;case"status":console.log(a);let t=await f.default.statusMatrix({fs:u.default,dir:a.path});console.log(t);const s=t.filter((e=>1!==e[1]||1!==e[2]||1!==e[3]));console.log(s);const r=[],n=[];return s.forEach((e=>{const t=e[0];switch(e.slice(1,4).join("")){case"020":r.push({path:t,status:"new-untracked",checked:!1});break;case"022":n.push({path:t,status:"added-staged",checked:!0});break;case"023":r.push({path:t,status:"modified-unstaged",checked:!1}),n.push({path:t,status:"new-untracked",checked:!0});break;case"121":r.push({path:t,status:"modified-unstaged",checked:!1});break;case"122":n.push({path:t,status:"modified-staged",checked:!0});break;case"123":r.push({path:t,status:"modified-unstaged",checked:!1}),n.push({path:t,status:"modified-staged",checked:!0});break;case"101":r.push({path:t,status:"deleted-unstaged",checked:!1});break;case"100":n.push({path:t,status:"deleted-staged",checked:!0});break;case"003":n.push({path:t,status:"added-staged",checked:!0}),r.push({path:t,status:"deleted",checked:!1})}})),console.log(n,r),new P(j,{stagedData:n,unstagedData:r});case"reset":console.log(a);try{for(const e of Array.isArray(a?.list)?a?.list:[a?.list])await f.default.resetIndex({fs:u.default,dir:a.project.path,filepath:e.path});return B(e,{type:"status",params:a.project})}catch(e){console.log(e)}break;case"add":console.log(a);try{for(const e of Array.isArray(a?.list)?a?.list:[a?.list])e.status.includes("delete")?await f.default.remove({fs:u.default,dir:a.project.path,filepath:e.path}):await f.default.add({fs:u.default,dir:a.project.path,filepath:e.path});return B(e,{type:"status",params:a.project})}catch(e){console.log(e)}break;case"commit":let o,i,l,d,p=[];const h=await f.default.getConfigAll({fs:u.default,dir:a.project.path,path:"user.name"});console.log(h),o=h.length?h[0]:"";if(o=(await f.default.getConfigAll({fs:u.default,dir:a.project.path,path:"user.email"})).length?h[0]:"",o?p.push(void 0):(l=new Promise(((e,t)=>{const a=c.exec("git config user.name",{async:!0});a&&(a.stdout.on("data",(function(t){t=t.replace(/\n/g,""),e(t)})),a.stderr.on("data",(e=>{t(e)})))})),p.push(l)),i?p.push(void 0):(d=new Promise(((e,t)=>{const a=c.exec("git config user.email",{async:!0});a.stdout.on("data",(function(t){t=t.replace(/\n/g,""),e(t)})),a.stderr.on("data",(e=>{t("error")}))})),p.push(d)),!p[0])return new P(v,{message:"请配置您的git用户名和邮箱地址，可以通过全局配置或项目配置"});try{const t=await Promise.all(p);return o=t[0],i=t[1]||"",await f.default.commit({fs:u.default,dir:a.project.path,message:a.desc,author:{name:o,email:i}}),B(e,{type:"status",params:a.project}),new P(j,{message:"提交成功"})}catch(e){return new P(v,{message:e})}}}if(d.default.initialize(),e.ipcMain.on("select",((t,a)=>{console.log(t,a),e.dialog.showOpenDialog({title:"选择文件",buttonLabel:"选择",properties:["openFile"],...a.params}).then((async e=>async function(e,t,a){const{canceled:s,filePaths:r}=a;switch(t.type){case"privatePath":e.reply("selectFileReply",new P(j,{type:t.type,path:r[0]}));break;case"export":if(r.length)if(k.read().get("list").value().map((e=>e.path)).includes(r[0]))e.reply("selectFolderReply",new P(v,{message:"当前项目已存在"}));else{const t=r[0],a=h.default.join(t,"/.git/HEAD"),s=u.default.existsSync(a),n=h.default.basename(t);let o,i=[],c=[],l="";s&&(c=await f.default.listBranches({fs:u.default,dir:t}),l=await f.default.currentBranch({fs:u.default,dir:t,fullname:!1}));const d=D(r[0],/(\.key)$/);if(o={projectName:n,name:n,path:r[0],branches:c,currentBranch:l,appid:"",outputPath:"",privatePath:d||"",robot:1,qrcodePath:"",done:!1,expireTime:"",pagePath:"",searchQuery:"",scene:"",threads:4,setting:{},desc:"",version:""},D(t,"pages.json")){const e=[void 0,void 0];i=[];const a=u.default.existsSync(h.default.join(t,"manifest.json"));e.forEach(((e,s)=>{i.push({...o,outputPath:h.default.join(t,`${a?"/unpackage":""}/dist/${0===s?"dev":"build"}/mp-weixin`),projectName:`${0===s?"dev":"prod"}: ${o.projectName}`})}))}else u.default.existsSync(h.default.join(t,"app.json"))&&(o.outputPath=r[0],i=o);if(console.log(i),Array.isArray(i))for(const e of i)k.read().get("list").insert(e).write();else k.read().get("list").insert(i).write();e.reply("selectFolderReply",new P(j,{message:"添加成功",data:i}))}break;case"outputPath":e.reply("selectFolderReply",new P(j,{type:t.type,path:r[0]}))}}(t,a,e)))})),e.ipcMain.on("miniProgram",((e,t)=>A(e,t))),e.ipcMain.handle("gitOperate",((e,t)=>B(e,t))),e.ipcMain.handle("commonOperate",((e,t)=>async function(e,t){const{type:a,params:s={}}=t;if("refresh"===a){console.log("进行刷新操作");const e=h.default.join(s.path,"/.git/HEAD");if(u.default.existsSync(e)){const e=await f.default.listBranches({fs:u.default,dir:s.path}),t=await f.default.currentBranch({fs:u.default,dir:s.path,fullname:!1});k.read().get("list").find({id:s.id}).assign({branches:e,currentBranch:t}).write()}else k.read().get("list").find({id:s.id}).assign({branches:"",currentBranch:[]}).write();return new P(j,{message:"刷新成功"})}}(0,t))),e.protocol.registerSchemesAsPrivileged([{scheme:"app",privileges:{standard:!0,supportFetchAPI:!0,secure:!0,corsEnabled:!0}}]),!e.app.isPackaged)try{require("electron-reloader")(module,{ignore:require("path").resolve(__dirname,"../db/db.json")})}catch(e){console.log(e)}function F(){e.protocol.registerBufferProtocol("app",((e,t)=>{let a=new URL(e.url).pathname,s=h.default.extname(a).toLowerCase();if(!s)return;a=decodeURI(a);let r=h.default.join(__dirname,a);u.default.readFile(r,((e,a)=>{if(e)return;let r="";".js"===s?r="text/javascript":".html"===s?r="text/html":".css"===s?r="text/css":".svg"===s?r="image/svg+xml":".json"===s&&(r="application/json"),t({mimeType:r,data:a})}))}));const t=new e.BrowserWindow({width:1392,height:800,resizable:!1,skipTaskbar:!1,frame:!1,thickFrame:!1,titleBarStyle:"hidden",titleBarOverlay:!0,maximizable:!1,transparent:!0,webPreferences:{nodeIntegration:!0,contextIsolation:!1}});return e.app.isPackaged?t.loadURL("app://./index.html"):t.loadURL("http://localhost:3000/"),t.webContents.openDevTools(),d.default.enable(t.webContents),t.on("focus",(()=>{console.log("聚焦")})),t}e.app.whenReady().then((()=>{const t=F(),a=e.nativeImage.createFromPath(h.default.join(process.cwd(),"win32"===process.platform?"/resource/tray_win@3x.png":"/resource/tray_mac@3x.png"));_=new e.Tray(a),"darwin"!==process.platform&&"win32"!==process.platform||_.on("right-click",(()=>{const a=e.Menu.buildFromTemplate([{label:"关于",click(){e.dialog.showMessageBox({title:"MpHelper",message:"微信小程序辅助工具",detail:"Version: 1.0.0\nAuthor: ShuHongXie\nGithub: https://github.com/ShuHongXie"})}},{label:"退出",click:(t,a,s)=>{e.app.quit()}}]);_.popUpContextMenu(a),_.on("click",(()=>{console.log("点击了"),t.show()}))})),e.app.on("activate",(function(){0===e.BrowserWindow.getAllWindows().length&&F()}))}));
//# sourceMappingURL=entry.js.map
